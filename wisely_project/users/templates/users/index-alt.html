{% extends 'base-app-alt.html' %}
{% load breaktag %}
{% load staticfiles %}
{% load breaktag %}
{% block headers_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/style-news.css' %}" cache="false"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/style-index.css' %}" cache="false"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/jquery.hoverscroll.css' %}"/>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
{% endblock %}
{% block content %}
    <div class="row wide-row" style="border-bottom: solid #D2D4D5 1px">
        <div class="large-4 columns" style="border-right: solid #D2D4D5 1px; padding-top: 40px; padding-bottom: 1%;">
            <div class="row">
                <div class="large-3 columns">
                    <img {% if user.userprofile.picture %}src="/media/{{ user.userprofile.picture }}"
                         {% else %}src="http://www.adas-lv.com/wp-content/uploads/2012/07/default_avatar.png"{% endif %}
                         class="pull-left img-circle">
                </div>
                <div class="large-6 columns">
                    <div style="margin-top: 10px">
                        <h3>{{ user.first_name }} {{ user.last_name }}</h3>

                        {% if user.userprofile.headline %}
                            <p>{{ user.userprofile.headline }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="large-3 columns">
                    <img src="{% static 'images/settings-icon.png' %}" style="width: 80%; margin-top: 10px">
                </div>
            </div>
        </div>
        <div class="large-8 columns" style="margin-top: 50px; text-align: center">
            <div class="row" id="filters">
                <div class="large-4 columns"><a href="#"><p class="selected-news" id="current-filt">Current Courses</p>
                </a></div>
                <div class="large-4 columns"><a href="#"><p id="past-filt">Past Courses</p></a></div>
                <div class="large-4 columns"><a href="#"><p id="all-filt">All Courses</p></a></div>
            </div>
        </div>
    </div>
    <div class="row wide-row" data-equalizer>
        <div class="large-4 columns">
            <div class="row">
                <div style="background: #0F486D; font-size: 1.2em; color: #fff; padding: 5%;" data-equalizer-watch>
                    <img
                            src="{% static 'images/book-icon-trans.png' %}" style="margin-right: 10px">My Courses
                </div>
            </div>
        </div>
        <div class="large-8 columns">
            <div class="row summary-courses" data-equalizer-watch>
                <div class="large-3 columns">
                    <p class="number-bold">{{ current_courses }}</p>

                    <p>CURRENT</p>
                </div>
                <div class="large-3 columns">
                    <p class="number-bold">{{ past_courses }}</p>

                    <p>COMPLETED</p>
                </div>
                <div class="large-3 columns">
                    <p class="number-bold">{{ user.userprofile.follows.count }}</p>

                    <p>FRIENDS</p>
                </div>
                <div class="large-3 columns">
                    <p class="number-bold">$ 0</p>

                    <p>EARNED</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row wide-row">
        <div class="large-12 columns">
            <div class="row">
                <dl class="tabs vertical" style="width: 100%" data-tab>
                    {% for course in user.courseraprofile.courses.all %}
                        <dd style="overflow: hidden; position: relative" data-id="{{ course.id }}"
                            class="course {% if course.get_amount_progress >= 100 %}past{% else %}current{% endif %}"><a
                                href="#panel{{ course.id }}a"
                                onclick="$('#filters').toggle();"
                                style="text-align: right; width: 33.333%; display: inline-block">{{ course.title }}</a>

                            <div style="margin: 0 0 0 2em; display: inline !important; height: 100%">
                                <div class="meter">
                                    <span style="width: {{ course.get_amount_progress }}%"></span>
                                </div>
                                <div style="font-size: 0;display: inline-block; width: 30%; height: 100%; position: absolute; right: 0">
                                    <div class="metrics score">
                                        <p>SCORE<br>
                                            <span class="overall-mark">50<sup>%</sup></span></p>
                                    </div>
                                    {% for pledge in pledges %}
                                        {% if pledge.course == course %}
                                            <div class="metrics goal">
                                                <p>GOAL<br>
                                                    <span class="overall-mark">{{ pledge.get_aim }}<sup>%</sup></span>
                                                </p>
                                            </div>
                                            <div class="metrics pledge share-it" data-share="{{ course.title }}"
                                                 data-shareid="{{ course.id }}">
                                                <p>PLEDGE<br>
                                                    <span class="overall-mark">${{ pledge.money }}</span></p>
                                            </div>
                                            {{ forloop|break }}
                                        {% elif forloop.counter == pledges.count %}
                                            {% if course.get_amount_progress <= 50 %}
                                                <div class="metrics goal" data-class="{{ course.title }}"
                                                     data-id="{{ course.id }}"><p>
                                                    <img src="{% static 'images/pledge-icon.png' %}"
                                                         class="pledge-start"></p>
                                                </div>
                                                <div class="metrics pledge">
                                                    <p><strong>&#151; &#151;</strong></p>
                                                </div>
                                            {% else %}
                                                <div class="metrics goal">
                                                    <p><strong>&#151; &#151;</strong></p>
                                                </div>
                                                <div class="metrics pledge">
                                                    <p><strong>&#151; &#151;</strong></p>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not pledges %}
                                        {% if course.get_amount_progress <= 50 %}
                                            <div class="metrics goal" data-class="{{ course.title }}"
                                                 data-id="{{ course.id }}">
                                                <p><img src="{% static 'images/pledge-icon.png' %}"
                                                        class="pledge-start"></p>
                                            </div>
                                            <div class="metrics pledge">
                                                <p><strong>&#151; &#151;</strong></p>
                                            </div>
                                        {% else %}
                                            <div class="metrics goal">
                                                <p><strong>&#151; &#151;</strong></p>
                                            </div>
                                            <div class="metrics pledge">
                                                <p><strong>&#151; &#151;</strong></p>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </dd>
                    {% endfor %}
                    {% for course in user.edxprofile.courses.all %}
                        <dd style="overflow: hidden; position: relative" data-id="{{ course.id }}"
                            class="course {% if course.get_amount_progress >= 100 %}past{% else %}current{% endif %}"><a
                                href="#panel{{ course.id }}a"
                                onclick="$('#filters').toggle();"
                                style="text-align: right; width: 33.333%; display: inline-block">{{ course.title }}</a>

                            <div style="margin: 0 0 0 2em; display: inline !important; height: 100%">
                                <div class="meter">
                                    <span style="width: {{ course.get_amount_progress }}%"></span>
                                </div>
                                <div style="font-size: 0;display: inline-block; width: 30%; height: 100%; position: absolute; right: 0">
                                    <div class="metrics score">
                                        <p>SCORE<br>
                                            <span class="overall-mark">50<sup>%</sup></span></p>
                                    </div>
                                    {% for pledge in pledges %}
                                        {% if pledge.course == course %}
                                            <div class="metrics goal">
                                                <p>GOAL<br>
                                                    <span class="overall-mark">{{ pledge.get_aim }}<sup>%</sup></span>
                                                </p>
                                            </div>
                                            <div class="metrics pledge share-it" data-share="{{ course.title }}"
                                                 data-shareid="{{ course.id }}">
                                                <p>PLEDGE<br>
                                                    <span class="overall-mark">${{ pledge.money }}</span></p>
                                            </div>
                                            {{ forloop|break }}
                                        {% elif forloop.counter == pledges.count %}
                                            {% if course.get_amount_progress <= 50 %}
                                                <div class="metrics goal pledge-start" data-class="{{ course.title }}"
                                                     data-id="{{ course.id }}"><p>
                                                    <img src="{% static 'images/pledge-icon.png' %}"></p>
                                                </div>
                                                <div class="metrics pledge">
                                                    <p><strong>&#151; &#151;</strong></p>
                                                </div>
                                            {% else %}
                                                <div class="metrics goal">
                                                    <p><strong>&#151; &#151;</strong></p>
                                                </div>
                                                <div class="metrics pledge">
                                                    <p><strong>&#151; &#151;</strong></p>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not pledges %}
                                        {% if course.get_amount_progress <= 50 %}
                                            <div class="metrics goal pledge-start" data-class="{{ course.title }}"
                                                 data-id="{{ course.id }}">
                                                <p><img src="{% static 'images/pledge-icon.png' %}"></p>
                                            </div>
                                            <div class="metrics pledge">
                                                <p><strong>&#151; &#151;</strong></p>
                                            </div>
                                        {% else %}
                                            <div class="metrics goal">
                                                <p><strong>&#151; &#151;</strong></p>
                                            </div>
                                            <div class="metrics pledge">
                                                <p><strong>&#151; &#151;</strong></p>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </dd>
                    {% endfor %}
                </dl>
            </div>
        </div>
    </div>
    {% for course in user.courseraprofile.courses.all %}
        <div class="class-progress row wide-row" id="course_graph_{{ course.id }}"
             style="display: none; max-height: 400px">
            <div class="large-4 columns">
                <div class="row">
                    <dl class="tabs vertical" style="width: 100%" data-tab>
                        {% for progress in progresses %}
                            {% if progress.quiz.course == course %}
                                <dd><a href="#"><p style="font-size: 1rem">{{ progress|safe }}</p></a></dd>
                            {% endif %}
                        {% endfor %}
                    </dl>
                </div>
            </div>
            <div class="large-8 columns">
                <p>Graph Coming Soon</p>
            </div>
        </div>
    {% endfor %}
    {% for course in user.edxprofile.courses.all %}
        <div class="class-progress row wide-row" id="course_graph_{{ course.id }}"
             style="display: none; max-height: 400px">
            <div class="large-4 columns">
                <div class="row">
                    <dl class="tabs vertical" style="width: 100%" data-tab>
                        {% for progress in progresses %}
                            {% if progress.quiz.course == course %}
                                <dd><a href="#"><p style="font-size: 1rem">{{ progress|safe }}</p></a></dd>
                            {% endif %}
                        {% endfor %}
                    </dl>
                </div>
            </div>
            <div class="large-8 columns">
                <p>Graph Coming Soon</p>
            </div>
        </div>
    {% endfor %}
    <div class="light-box" id="share-box">
        <div id="share-title"></div>
        <button class="btn-auth btn-facebook" id="share-facebook" type="submit">Share
            on <b>Facebook</b>
        </button>
        <a class="twitter popup"
           href="">
            <button class="btn-auth btn-twitter" id="share-twitter" type="submit">Share
                on <b>Twitter</b>
            </button>
        </a>
    </div>
    <div class="light-box" id="pledge-box">
        <div class="row">
            <div id="class-title"></div>
            <input type="hidden" id="class-id">

            <div class="summary row">
                <div class="large-4 columns">
                    <p>STUDENTS</p>

                    <p id="number_pledges">0</p>
                </div>
                <div class="large-4 columns">
                    <p>AVG. PLEDGE</p>

                    <p id="avg_aim">N/A</p>
                </div>
                <div class="large-4 columns">
                    <p>REWARD</p>

                    <p id="probable_reward"><sup>$</sup>0</p>
                </div>
            </div>
            <div style="position: relative; overflow: hidden">
                <div id="goal-slider">
                </div>
                <div class="right">
                    <p style="margin-bottom: 0; font-size: 1rem">GOAL</p>

                    <p style="margin-bottom: 0" id="goal-value">75<sup>%</sup></p>
                </div>
            </div>
            <div style="position: relative; overflow: hidden">

                <div id="pledge-slider">
                </div>
                <div class="right">
                    <p style="margin-bottom: 0;  font-size: 1rem">PLEDGE</p>

                    <p style="margin-bottom: 0" id="pledge-value"><sup>$</sup>30</p>
                </div>
            </div>
            <button id="make-pledge">Save Goal and Pledge</button>
        </div>
    </div>
    <div id="other-messages" class="light-box">
        <i class="fa fa-times-circle-o close" style="margin-top: -25px; margin-right: -30px; float: right"></i>

        <div class="row text-center" id="other-message">
        </div>
    </div>
{% endblock %}
{% block additionalScripts %}
    <script src="{% static 'js/foundation/foundation.equalizer.js' %}"></script>
    <script src="{% static 'js/jquery.hoverscroll.js' %}"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script>
        $(function () {
            $('.past').hide();
            $('.current').show();
            $('#past-filt').click(function () {
                $('.past').show();
                $('.current').hide();
                $('#filters').find('p').removeClass('selected-news');
                $(this).addClass('selected-news');
            });

            $('#current-filt').click(function () {
                $('.past').hide();
                $('.current').show();
                $('#filters').find('p').removeClass('selected-news');
                $(this).addClass('selected-news');
            });

            $('#all-filt').click(function () {
                $('.past').show();
                $('.current').show();
                $('#filters').find('p').removeClass('selected-news');
                $(this).addClass('selected-news');
            });
            var full = true;
            $('.course').find('a').click(function () {
                if (full) {
                    $('.course').hide();
                    $(this).parent().show();
                    $(this).parent().addClass('active');
                    $('#course_graph_' + $(this).parent().data('id')).show();
                    full = false;
                } else {
                    full = true;
                    $('.course').show();
                    $('#course_graph_' + $(this).parent().data('id')).hide();
                    $(this).parent().removeClass('active');
                }
            });
            $('.class-progress').find('dl').hoverscroll({
                vertical: true,
                height: 400,
                arrows: true,
                arrowsOpacity: 0.5,
            });
            var projected_amount = 5;
            var average_aim = 75;
            var current_name = "";
            var current_id;
            $('.pledge-start').click(function () {
                var $clicked = $(this);
                current_id = $clicked.data('id');
                current_name = $clicked.data('class');
                $('#class-title').html('<p>' + current_name + '</p>');
                $('#class-id').val(current_id);
                $.get('{% url 'users:get_course_stats' %}', {'id': current_id}, function (data) {
                    if (parseInt(data['fail']) == 0) {
                        if (parseInt(data['count']) != 0) {
                            $('#number_pledges').text(data['count']);
                            $('#avg_aim').html(data['avg_aim'] + '<sup>%</sup>');
                            average_aim = parseInt(data['avg_aim']);
                            projected_amount = parseInt(data['probable_reward']);
                        }
                        $('#probable_reward').html('<sup>$</sup>' + data['probable_reward']);
                    }
                    $('#pledge-box').lightbox_me({centered: true});
                });
            });
            $("#goal-slider").slider({
                value: 75,
                range: "min",
                min: 0,
                step: 5,
                max: 100,
                slide: function (event, ui) {
                    if (ui.value <= 45) {
                        return false;
                    }
                    $('#goal-value').html(ui.value.toString() + '<sup>%</sup>');
                    var value =
                            projected_amount *
                                    (1 + (ui.value / 100 - average_aim / 100) / (average_aim / 100));
                    if (isNaN(value)) {
                        value = 5;
                    }
                    value = Math.round(value * 100) / 100;
                    $('#probable_reward').html('<sup>$</sup>' + value.toString());
                }
            });
            $("#pledge-slider").slider({
                value: 30,
                range: "min",
                min: 0,
                step: 5,
                max: 100,
                slide: function (event, ui) {
                    if (ui.value <= 5) {
                        return false;
                    }
                    $('#pledge-value').html('<sup>$</sup>' + ui.value.toString());
                }
            });

            $('#make-pledge').click(function () {
                var token = function (res) {
                    $.post('{% url 'pledges:create_ajax' %}', {'stripeToken': res.id, 'course': current_id, 'money': money,
                        'aim': aim
                    }, function (data) {
                        if (parseInt(data['fail']) == 0) {
                            //TODO: update div
                            $('div[data-id="' + current_id.toString() + '"]').html('<p>GOAL<br><span class="overall-mark">' + aim.toString() + '<sup>%</sup></span></p>');
                            var $new_share = $('div[data-id="' + current_id.toString() + '"] + div');
                            $new_share.html('<p>PLEDGE<br><span class="overall-mark">$' + money.toString() + '</span></p>');
                            $new_share.data('share', current_name);
                            $new_share.data('shareid', data['id']);
                            $new_share.addClass('share-it');
                            temp_div[$new_share] = $new_share.html();
                            $('#make-pledge').trigger('close');
                        } else {
                            $('#other-message').text(data['message']);
                            $('#other-messages').lightbox_me({centered: true});
                        }
                    });
                };
                var money = parseInt($('#pledge-value').text().replace('$', ''));
                var aim = parseInt($('#goal-value').text().replace('%', ''));
                if (!isNaN(money)) {
                    StripeCheckout.open({
                        key: 'pk_test_GUMeKfQZ4BkZzS5GyaZzG7Qb',
                        address: false,
                        amount: money * 100,
                        currency: 'cad',
                        name: "Pledge",
                        description: "For " + current_name,
                        panelLabel: 'Pledge ',
                        token: token
                    });
                }
            });
            var share_name = "";
            var share_id = 0;
            var temp_div = {};
            $('.share-it').each(function (index, value) {
                temp_div[$(this)] = $(this).html();
            });
            $('.share-it').hover(function () {
                $(this).html('<p><img src="{% static 'images/connect-icon.png' %}" valign="middle" style="display: inline"></p>');
            }, function () {
                $(this).html(temp_div[$(this)]);
            });

            $('.share-it').click(function () {
                share_name = $(this).data('share');
                share_id = parseInt($(this).data('shareid'));
                var $share_box = $('#share-box');
                $('#share-title').html('<p>' + share_name + '</p>');
                $share_box.find('.twitter').attr('href', get_twitter_string());
                $share_box.lightbox_me({centered: true});
            });

            $('#share-facebook').click(function () {
                FB.ui(
                        {
                            method: 'feed',
                            name: 'Pledge for ' + share_name,
                            description: (
                                    'I' + ' have just made a' +
                                            ' pledge for ' + share_name + ', help me stay motivated by following the pledge.'
                                    ),
                            link: 'http://www.projectwisely.com/follow/' + share_id.toString(),
                            picture: 'http://www.fbrell.com/public/f8.jpg'
                        },
                        function (response) {
                            if (response && response.post_id) {
                            } else {
                            }
                        }
                );
            });

            function get_twitter_string() {
                return "http://twitter.com/share?text=Just%20made%20a%20pledge%20for%20" + share_name + "%2C%20help%20me%20stay%20motivated%20by%20following%20the%20pledge!&url=http://www.projectwisely.com/follow/" + share_id;
            }
        });
    </script>
    <div id="fb-root"></div>
    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: '405339162934237',
                status: true,
                xfbml: true
            });
        };
        $(function () {
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "//connect.facebook.net/en_US/all.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));

        });

        $('.popup').click(function (event) {
            var width = 575,
                    height = 400,
                    left = ($(window).width() - width) / 2,
                    top = ($(window).height() - height) / 2,
                    url = this.href,
                    opts = 'status=1' +
                            ',width=' + width +
                            ',height=' + height +
                            ',top=' + top +
                            ',left=' + left;

            window.open(url, 'twitter', opts);

            return false;
        });

    </script>
{% endblock %}